<?php

ini_set('display_errors', 1);
ini_set('display_startup_errors', 1);
error_reporting(E_ALL);

session_start();

require($_SERVER['DOCUMENT_ROOT'] . '/private/utils/forum.php');
require($_SERVER['DOCUMENT_ROOT'] . '/private/utils/mailer.php');
require($_SERVER['DOCUMENT_ROOT'] . '/private/captchaUtils.php');

include __DIR__ . '/private/forumController.php';
include __DIR__ . '/private/authController.php';
include __DIR__ . '/private/userController.php';
include __DIR__ . '/private/projectController.php';
include __DIR__ . '/private/adminController.php';

function my_error_handler()
{
    $last_error = error_get_last();
    if ($last_error && $last_error['type'] == E_ERROR) {
        header("HTTP/1.1 500 Internal Server Error");
    }
}

header("Content-Type: application/json");

function is_moderator() : bool{
    $user = get_log_user();
    return $user->is_connected() && $user->get_permission_level() >= PERMISSION_MODERATOR;
}

function is_admin() : bool {
    $user = get_log_user();
    return $user->is_connected() && $user->get_permission_level() >= PERMISSION_ADMIN;
}

function bad_method()
{
    json_exit(405, "Method Not Allowed", "Only accept POST");
}

function bad_request($reason = "")
{
    json_exit(400, "Bad Request", $reason);
}

function unauthorized() {
    json_exit(401, "Unauthorized", "Une authentification est nécessaire pour accéder à la ressource.");
}

function forbidden() {
    json_exit(403, "Forbidden", "Forbidden");
}

function success($data = []) {
    http_response_code(200);
    echo json_encode(["code" => 200, "data" => $data]);
    exit();
}

register_shutdown_function('my_error_handler');

$uri = explode('/', parse_url($_SERVER['REQUEST_URI'], PHP_URL_PATH));
$controller = $uri[3] ?? null;
$function = array_slice($uri, 4);
parse_str($_SERVER['QUERY_STRING'], $query);
$method = strtoupper($_SERVER["REQUEST_METHOD"]);

switch ($controller) {
    case 'forum':
        invokeForm($method, $function, $query);break;
    case 'auth':
        invokeAuth($method, $function, $query); break;
    case 'user':
        invokeUser($method, $function, $query); break;
    case 'captchaSettings':
        if ($method === 'GET' && count($function) === 0) _get_captcha_settings();
        break;
    case 'project':
        invokeProject($method, $function, $query); break;
    case 'admin':
        invokeAdmin($method, $function, $query); break;
    default:
        break;
}


function _get_captcha_settings() {
    success([
        "width" => CAPTCHA_WIDTH,
        "height" => CAPTCHA_HEIGHT,
        "piece_size" => CAPTCHA_PIECE_SIZE,
        "cell_size" => CAPTCHA_CELL_SIZE,
        "number_piece" => CAPTCHA_NUMBER_PIECE,
    ]);
}

header("HTTP/1.1 404 Not Found");
exit();
